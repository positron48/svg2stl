# SVG to STL Converter

Скрипт на Python для преобразования SVG-файлов (в частности, негативных масок печатных плат, экспортированных из KiCad) в 3D-модели формата STL для фотополимерной печати.

## Описание

Этот инструмент автоматизирует процесс преобразования SVG-файлов, экспортированных из KiCad (с черной заливкой, представляющей негатив маски печатной платы), в точные 3D-модели в формате STL для использования с фотополимерными принтерами, такими как Photon Mono X6KS.

## Установка и запуск

### Вариант 1: Готовые бинарные файлы

Скачайте готовый исполняемый файл для вашей операционной системы из [раздела релизов](https://github.com/YOURNAME/svg-to-stl/releases):

- **Windows**: svg2stl-windows.exe
- **macOS**: svg2stl-macos
- **Linux**: svg2stl-linux

После скачивания:
- **Windows**: Просто запустите exe-файл двойным кликом
- **macOS/Linux**: Сделайте файл исполняемым (`chmod +x svg2stl-*`) и затем запустите его через терминал

> **Примечание для пользователей Linux**: Бинарные файлы скомпилированы на старых системах Linux (Ubuntu 20.04) для максимальной совместимости с большинством дистрибутивов. Если всё же возникают ошибки, используйте метод запуска из исходного кода.

### Вариант 2: Запуск из исходного кода

Требуется Python 3.7 или выше и следующие пакеты:
```
numpy
cairosvg
pillow
numpy-stl
tqdm
```

Установка зависимостей:
```
pip install -r requirements.txt
```

Запуск:
```
python svg2stl.py input.svg --thickness 1.0 --pixel_size 0.05
```

## Особенности

- Преобразование SVG-файлов в высококачественные 3D-модели STL
- Точное определение и извлечение только черных элементов из SVG (трасс и контуров плат)
- Автоматическая обрезка до фактических границ содержимого, значительно уменьшающая размер модели
- Продвинутая оптимизация 3D-модели с объединением смежных пикселей в минимальное количество прямоугольников
- Обработка отдельных файлов или всех SVG-файлов в каталоге
- Настраиваемые параметры для толщины и размера пикселя (разрешения)
- Автоматический расчет оптимального DPI для растеризации на основе размера пикселя
- Индикатор прогресса для отслеживания процесса конвертации

## Использование

### Преобразование одного SVG-файла:

```
svg2stl input.svg --thickness 1.0 --pixel_size 0.05
```

### Преобразование всех SVG-файлов в текущем каталоге:

```
svg2stl --all --thickness 1.0 --pixel_size 0.05
```

### Параметры:

- `--thickness`: Толщина результирующей 3D-модели в мм (по умолчанию: 1.0)
- `--pixel_size`: Размер каждого пикселя в мм (по умолчанию: 0.05). Определяет разрешение растеризации и детализацию модели
- `--debug`: Сохранять обрезанное изображение для проверки

## Расчет разрешения

Скрипт автоматически рассчитывает оптимальное значение DPI на основе размера пикселя, чтобы обеспечить точные размеры STL-модели:

| Размер пикселя | Рассчитанный DPI | Качество | Размер файла | Время обработки |
|----------------|------------------|----------|--------------|-----------------|
| 0.025 мм       | 1200 DPI         | Очень высокое | ~5 МБ | ~4 сек |
| 0.05 мм        | 600 DPI          | Высокое  | ~3 МБ | ~2 сек |
| 0.1 мм         | 300 DPI          | Среднее  | ~2 МБ | ~1 сек |
| 0.2 мм         | 150 DPI          | Низкое   | ~1 МБ | <1 сек |

Используется формула: `DPI = 30 / pixel_size`

## Оптимизация 3D-модели

Скрипт использует двухуровневый алгоритм оптимизации для объединения смежных пикселей в минимальное количество прямоугольных блоков:

1. **Поиск максимальных прямоугольников**: Находит все возможные прямоугольники, которые могут быть созданы из смежных пикселей.

2. **Жадное покрытие площади**: Объединяет найденные прямоугольники, начиная с самых больших и избегая избыточного перекрытия:
   - Прямоугольники сортируются по площади от большего к меньшему
   - Прямоугольники, полностью перекрытые другими, отбрасываются
   - Маленькие прямоугольники объединяются в более крупные блоки

Результаты оптимизации впечатляют:
- **До оптимизации**: ~175 000 прямоугольников (по одному на каждый пиксель)
- **После оптимизации**: ~3 000 прямоугольников (сокращение в ~60 раз)

Это позволяет создавать очень компактные STL-файлы (1-5 MB) даже для моделей с высоким разрешением, сохраняя при этом высокую точность и скорость обработки.

## Рекомендации по производительности

Размер пикселя (`pixel_size`) полностью определяет разрешение и детализацию модели:

- **Высокое качество и точность**: `--pixel_size 0.05` (DPI: 600)
- **Хороший баланс качества и производительности**: `--pixel_size 0.1` (DPI: 300)
- **Быстрая обработка с приемлемым качеством**: `--pixel_size 0.2` (DPI: 150)
- **Чрезвычайно высокое качество**: `--pixel_size 0.025` (DPI: 1200)

```
svg2stl input.svg --thickness 1.0 --pixel_size 0.1
```

Благодаря умной обрезке по содержимому и продвинутой оптимизации меша, скрипт обрабатывает только фактические элементы платы и генерирует компактные, оптимизированные STL-файлы.

## Процесс преобразования

1. SVG-файл растеризуется в PNG-изображение с разрешением DPI, рассчитанным на основе размера пикселя
2. Выполняется извлечение только черных элементов из SVG (трасс и контуров плат)
3. Изображение автоматически обрезается до фактических границ содержимого, игнорируя пустые поля
4. Создается бинарная маска, представляющая тело печатной платы
5. В маске выполняется поиск и оптимизация максимальных прямоугольников
6. Для каждого прямоугольника создается 3D-блок с заданной толщиной
7. Все блоки объединяются в единую 3D-модель, которая сохраняется в STL-формате

## Примеры

Преобразование экспорта медного слоя KiCad в STL толщиной 0.8 мм с высоким разрешением (600 DPI):
```
svg2stl board-F_Cu.svg --thickness 0.8 --pixel_size 0.05
```

Обработка всех SVG-файлов с очень высоким разрешением (1200 DPI):
```
svg2stl --all --thickness 1.0 --pixel_size 0.025
```

Быстрая обработка большого файла с более низким разрешением (300 DPI):
```
svg2stl large-board.svg --thickness 1.0 --pixel_size 0.1
```

Сохранение отладочного изображения для проверки обрезки:
```
svg2stl board-F_Cu.svg --thickness 1.0 --pixel_size 0.1 --debug
```

## Сборка из исходного кода

Для создания собственного бинарного файла из исходного кода с максимальной совместимостью:

### Linux (для максимальной совместимости)
```
# Рекомендуется использовать старые дистрибутивы (например, Ubuntu 18.04 или 20.04)
pip install pyinstaller
pyinstaller --onefile --clean --name svg2stl \
  --hidden-import=PIL._tkinter_finder \
  --exclude-module=tcl \
  --exclude-module=tk \
  --exclude-module=Tkinter \
  --exclude-module=_tkinter \
  svg2stl.py
```

### Windows и macOS
```
pip install pyinstaller
pyinstaller --onefile svg2stl.py
```

Готовый исполняемый файл будет создан в папке `dist/`.

## Устранение неполадок

### Проблемы совместимости на Linux

Если вы столкнулись с ошибками вида `GLIBC_2.xx not found`, это означает, что бинарный файл был собран с более новой версией библиотек Linux, чем доступны в вашей системе. Используйте одно из этих решений:

1. Запустите скрипт напрямую с Python (Вариант 2)
2. Соберите собственный бинарный файл с помощью PyInstaller на вашей системе, используя инструкции выше
